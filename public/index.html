<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title> Snow craft </title>
  </head>

  <body oncontextmenu="return false">
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script>

      $(function() {
        var GAME_SETTINGS = null;
        var currentMousePos = {x:-1,y:-1};
        var user = {x:0,y:0};
        //user status 필요한것 전역변수로 tracking할 수 있음.



        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        $(canvas).css("display","block");
        $(canvas).css("border","black 1px solid");
        $(canvas).css("margin","0 auto");   // Canvas 에 기본적인 css 스타일 먹여놓기

        var socket = io(); // socket connect!! id createElement

        socket.on('get_initial_game_settings', function(SERVER_GAME_SETTINGS) {
          GAME_SETTINGS = SERVER_GAME_SETTINGS;
          $(canvas).attr("width",GAME_SETTINGS.WIDTH);
          $(canvas).attr("height",GAME_SETTINGS.HEIGH);
          document.body.appendChild(canvas);
          drawBackground();

        });

        function drawBackground() {
          ctx.fillStyle = GAME_SETTINGS.BACKGROUND_COLOR;
          ctx.fillRect(0,0,GAME_SETTINGS.WIDTH,GAME_SETTINGS.HEIGH);
        }

        $('body').mousemove(function (event) {
          currentMousePos.x = event.pageX - $(canvas).offset().left - user.x;
          currentMousePos.y = event.pageY - $(canvas).offset().top - user.y;

        });

        socket.on('update',function(idArray, userStatusArray, bulletArray) {
          if(GAME_SETTINGS == null) return;

          ctx.clearRect(0,0,GAME_SETTINGS.WIDTH,GAME_SETTINGS.HEIGH);
          //console.log("socket.id : ", socket.id);
          //console.log(typeof socket.id);

          user.x = userStatusArray["/#" + socket.id].x;
          user.y = userStatusArray["/#" + socket.id].y;

          idArray.forEach(function(id,i,a) {
            ctx.fillStyle = userStatusArray[id].color;
            ctx.fillRect(userStatusArray[id].x,userStatusArray[id].y,30,30);


            ctx.beginPath();
            ctx.arc(userStatusArray[id].x,userStatusArray[id].y,userStatusArray[id].radius*Math.PI,0,2*Math.PI,true);
            console.log(userStatusArray[id].radius);
            ctx.closePath();
            ctx.fill();

          })

          ctx.fillStyle = "#00FF00";

          for(var i=0;i<bulletArray.length;i++) {

            //ctx.fillRect(Math.round( bulletArray[i].status.x ),Math.round(bulletArray[i].status.y),10,10);
            ctx.beginPath();
            ctx.arc(Math.round( bulletArray[i].status.x ), Math.round( bulletArray[i].status.y) ,2*Math.PI,0,2*Math.PI,true);
            ctx.closePath();
            ctx.fill();
          }

        })

        $('body').on('keydown',function(event) {

          if(event.keyCode == 32){
            event.preventDefault();
            var square = Math.sqrt(currentMousePos.x*currentMousePos.x + currentMousePos.y*currentMousePos.y);
            socket.emit('spacePress',(5*currentMousePos.x)/square, (5*currentMousePos.y)/square);

          }
        });



      })


    </script>


</html>
