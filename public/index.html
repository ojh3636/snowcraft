<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8"
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title> Snow craft </title>
  </head>

  <body>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//code.jquery.com/jquery-1.11.1.js"></script>
    <script>

      $(function() {
        var GAME_SETTINGS = null;
        var currentMousePos = {x:-1, y: -1};
        var user = {x:0, y:0};
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        $(canvas).css("display","block");
        $(canvas).css("border","black 1px solid");
        $(canvas).css("margin","0 auto");   // Canvas 에 기본적인 css 스타일 먹여놓기

        var socket = io(); // socket connect!! id createElement

        $('body').on('keydown', function(e){
          socket.emit('keydown', e.keyCode)
        });
        $('body').on('keyup', function(e){
          socket.emit('keyup', e.keyCode)
        });
        $('body').on('mousemove', function(e){
          currentMousePos.x = event.pageX - $(canvas).offset().left - user.x;
          currentMousePos.y = event.pageY - $(canvas).offset().top - user.y;
        });
        socket.on('get_initial_game_settings', function(SERVER_GAME_SETTINGS) {
          GAME_SETTINGS = SERVER_GAME_SETTINGS;
          $(canvas).attr("width",GAME_SETTINGS.WIDTH);
          $(canvas).attr("height",GAME_SETTINGS.HEIGH);
          document.body.appendChild(canvas);

        });

        function drawBackground() {
          ctx.fillStyle = GAME_SETTINGS.BACKGROUND_COLOR;
          ctx.fillRect(0,0,GAME_SETTINGS.WIDTH,GAME_SETTINGS.HEIGH);
        }

        socket.on('update',function(idArray, userStatusArray) {

          ctx.clearRect(0,0,GAME_SETTINGS.WIDTH,GAME_SETTINGS.HEIGH);
          user.x = userStatusArray["/#"+socket.id].x;
          user.y = userStatusArray["/#"+socket.id].y;
          idArray.forEach(function(id,i,a) {
            var t = Math.atan(currentMousePos.y/currentMousePos.x);
            ctx.save();
            ctx.translate(userStatusArray[id].x, userStatusArray[id].y);
            ctx.rotate(t);
            ctx.fillStyle = userStatusArray[id].color;
            ctx.fillRect(-15,-15,30,30);
            ctx.restore();
          })

        })




      })


    </script>


</html>
